#!/bin/bash
# ============================================
# post-commit hook: コミット後の自動プッシュ
# ハイブリッド構成の自動同期 (Phase 2)
# ============================================

set -euo pipefail

# カラー定義
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m'

# 現在のブランチ取得
BRANCH=$(git branch --show-current 2>/dev/null || echo "")

# デタッチ状態の場合はスキップ
if [ -z "$BRANCH" ]; then
  exit 0
fi

# 保護ブランチの定義
PROTECTED_BRANCHES="main master develop"

# 保護ブランチかどうかをチェック
is_protected_branch() {
  local branch="$1"
  for protected in $PROTECTED_BRANCHES; do
    if [ "$branch" = "$protected" ]; then
      return 0
    fi
  done
  return 1
}

# リモートが設定されているか確認
has_upstream() {
  git rev-parse --abbrev-ref "@{upstream}" >/dev/null 2>&1
}

# メイン処理
if is_protected_branch "$BRANCH"; then
  # 保護ブランチの場合は警告のみ（自動 push しない）
  echo -e "${YELLOW}[post-commit] 保護ブランチ ($BRANCH) - 自動pushスキップ${NC}"
  echo -e "${CYAN}  手動で push してください: git push${NC}"
else
  # feature ブランチの場合は自動 push
  if has_upstream; then
    echo -e "${CYAN}[post-commit] 自動プッシュ中... ($BRANCH)${NC}"
    local push_output
    if push_output=$(git push 2>&1); then
      echo -e "${GREEN}[post-commit] ✓ プッシュ完了${NC}"
    else
      echo -e "${YELLOW}[post-commit] プッシュ失敗:${NC}"
      echo "$push_output" | sed 's/^/  /'
    fi
  else
    echo -e "${YELLOW}[post-commit] upstream未設定 - 初回は手動でpushしてください${NC}"
    echo -e "${CYAN}  git push -u origin $BRANCH${NC}"
  fi
fi
