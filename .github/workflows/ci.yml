name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lint-js:
    name: Lint JavaScript
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  lint-shell:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          find . -name "*.sh" -type f | xargs shellcheck --severity=warning || true
          # 厳密モード（エラーのみ）
          find . -name "*.sh" -type f | xargs shellcheck --severity=error

  validate-yaml:
    name: Validate YAML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate workflow files
        run: |
          for file in .github/workflows/*.yml; do
            echo "Validating $file..."
            python3 -c "import yaml,sys; yaml.safe_load(open(sys.argv[1]))" "$file" || exit 1
          done
          echo "All YAML files are valid"

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          # 簡易シークレットスキャン
          if grep -rE "(sk-[a-zA-Z0-9]{20,}|AKIA[A-Z0-9]{16}|ghp_[a-zA-Z0-9]{36})" \
             --include="*.js" --include="*.sh" --include="*.md" .; then
            echo "::error::Potential secrets found in code!"
            exit 1
          fi
          echo "No hardcoded secrets detected"

      - name: Check for dangerous patterns
        run: |
          # eval, rm -rf / などの危険パターン
          if grep -rE "eval\s*\(" --include="*.js" . | grep -v "no-eval"; then
            echo "::warning::eval() usage detected - review carefully"
          fi
          echo "Security patterns check complete"
