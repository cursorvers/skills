{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$comment": "cursorvers 営業 Workflow 全体監査設定 - Single Source of Truth",

  "schedule": {
    "cron": "0 0 * * *",
    "timezone": "Asia/Tokyo",
    "description": "毎朝 JST 9:00 (UTC 0:00) に全システム監査"
  },

  "notification": {
    "discord": {
      "channel": "#monitoring",
      "webhookSecretName": "DISCORD_MONITORING_WEBHOOK"
    },
    "github": {
      "createIssue": true,
      "labels": ["audit", "needs-review"]
    }
  },

  "tiers": {
    "CRITICAL": {
      "description": "システム入口・認証・金銭・機密",
      "failureAction": "immediate_alert",
      "manusInvestigation": true,
      "repositories": [
        {
          "name": "cursorvers_line_free_dev",
          "owner": "cursorvers",
          "checks": [
            {
              "id": "front-door-signature",
              "name": "Front Door 署名検証",
              "type": "file_exists_and_contains",
              "path": "functions/relay/index.ts",
              "pattern": "crypto\\.createHmac|X-Line-Signature",
              "severity": "severe"
            },
            {
              "id": "timing-safe-comparison",
              "name": "タイミングセーフ比較",
              "type": "file_contains",
              "path": "functions/relay/index.ts",
              "pattern": "timingSafeEqual|crypto\\.subtle\\.timingSafeEqual",
              "severity": "severe",
              "note": "Bearer トークン比較でタイミング攻撃を防ぐ"
            },
            {
              "id": "github-actions-active",
              "name": "GitHub Actions Workflow 有効化",
              "type": "workflow_status",
              "workflows": ["line-event.yml", "manus-progress.yml"],
              "expectedState": "active",
              "severity": "severe"
            },
            {
              "id": "supabase-rls",
              "name": "Supabase RLS ポリシー",
              "type": "file_contains",
              "path": "supabase/migrations/*.sql",
              "pattern": "CREATE POLICY|ALTER TABLE.*ENABLE ROW LEVEL SECURITY",
              "severity": "severe",
              "note": "progress_events, line_members テーブルに RLS 必須"
            },
            {
              "id": "database-rls",
              "name": "Database RLS ポリシー",
              "type": "file_contains",
              "path": "database/migrations/*.sql",
              "pattern": "CREATE POLICY|ENABLE ROW LEVEL SECURITY",
              "severity": "severe",
              "note": "Subagent発見: 0001_init_tables.sql に RLS 未定義"
            },
            {
              "id": "deduplication",
              "name": "重複排除ロジック",
              "type": "file_contains",
              "path": "functions/relay/index.ts",
              "pattern": "dedup|idempotency|cache\\.get",
              "severity": "moderate"
            }
          ]
        },
        {
          "name": "cursorvers_discord_dev",
          "owner": "cursorvers",
          "checks": [
            {
              "id": "webhook-signature",
              "name": "Webhook 署名検証",
              "type": "file_contains",
              "path": "apps/discord-bot/src/webhooks/server.ts",
              "pattern": "verifySignature|X-Line-Signature|crypto",
              "severity": "severe"
            },
            {
              "id": "timing-safe-comparison",
              "name": "タイミングセーフ比較",
              "type": "file_contains",
              "path": "apps/discord-bot/src/webhooks/server.ts",
              "pattern": "timingSafeEqual",
              "severity": "severe",
              "note": "Subagent発見: server.ts で標準比較使用（タイミング攻撃リスク）"
            },
            {
              "id": "edge-function-timing-safe",
              "name": "Edge Function タイミングセーフ",
              "type": "file_contains",
              "path": "functions/relay/index.ts",
              "pattern": "timingSafeEqual",
              "severity": "severe"
            },
            {
              "id": "phi-security-filter",
              "name": "PHI セキュリティフィルタ",
              "type": "file_contains",
              "path": "apps/discord-bot/src/middleware/security.ts",
              "pattern": "detectSensitiveTokens|PHI|REGEXES",
              "severity": "severe"
            },
            {
              "id": "phi-escalation",
              "name": "PHI エスカレーション",
              "type": "file_contains",
              "path": "apps/discord-bot/src/middleware/security.ts",
              "pattern": "resolveEscalationChannel|notifyOpsBulletins",
              "severity": "moderate"
            },
            {
              "id": "heartbeat-monitor",
              "name": "Heartbeat 監視",
              "type": "file_exists",
              "path": "apps/discord-bot/src/health/monitor.ts",
              "severity": "moderate"
            },
            {
              "id": "heartbeat-interval",
              "name": "Heartbeat 間隔設定",
              "type": "file_contains",
              "path": "apps/discord-bot/src/health/monitor.ts",
              "pattern": "HEARTBEAT_INTERVAL_MS",
              "severity": "moderate"
            }
          ]
        },
        {
          "name": "skills",
          "owner": "cursorvers",
          "checks": [
            {
              "id": "manus-guard-rail",
              "name": "Manus Guard Rail 設定",
              "type": "file_contains",
              "path": "scripts/delegate-manus.js",
              "pattern": "checkApproval|checkCreditLimits|severity",
              "severity": "severe"
            },
            {
              "id": "quality-gates-manus",
              "name": "Quality Gates Manus 設定",
              "type": "json_key_exists",
              "path": "../.claude/rules/quality-gates.json",
              "key": "manus.approval",
              "severity": "moderate"
            }
          ]
        }
      ]
    },

    "HIGH": {
      "description": "ビジネスロジック・監視・エスカレーション",
      "failureAction": "alert_and_issue",
      "manusInvestigation": false,
      "repositories": [
        {
          "name": "cursorvers_line_paid_dev",
          "owner": "cursorvers",
          "checks": [
            {
              "id": "firestore-rules",
              "name": "Firestore Security Rules",
              "type": "file_exists",
              "path": "firestore.rules",
              "severity": "severe",
              "note": "Subagent発見: firestore.rules ファイルが存在しない - CRITICAL"
            },
            {
              "id": "line-signature-verification",
              "name": "LINE 署名検証",
              "type": "file_contains",
              "path": "apps/line-plus-bot/src/security/lineSignature.ts",
              "pattern": "createHmac|timingSafeEqual",
              "severity": "severe"
            },
            {
              "id": "member-management",
              "name": "会員管理ロジック",
              "type": "file_contains",
              "path": "apps/line-plus-bot/src/**/*.ts",
              "pattern": "subscription|member|updateMember",
              "severity": "moderate"
            },
            {
              "id": "subscription-state",
              "name": "サブスクリプション状態管理",
              "type": "file_contains",
              "path": "apps/line-plus-bot/src/types/member.ts",
              "pattern": "planType|status|active|paused|cancelled",
              "severity": "moderate",
              "note": "Subagent発見: expiresAt, renewalAt フィールド未実装"
            },
            {
              "id": "notification-idempotency",
              "name": "通知の冪等性",
              "type": "file_contains",
              "path": "apps/line-plus-bot/src/services/notificationService.ts",
              "pattern": "dedup|idempotent|deadLetter",
              "severity": "moderate"
            },
            {
              "id": "cloud-run-secrets",
              "name": "Cloud Run シークレット管理",
              "type": "file_contains",
              "path": "infra/cloud-run/webhook.service.yaml",
              "pattern": "secretKeyRef|Secret Manager",
              "severity": "moderate"
            }
          ]
        },
        {
          "name": "Cursorvers_LINEsystem",
          "owner": "cursorvers",
          "checks": [
            {
              "id": "miyabi-agents",
              "name": "Miyabi エージェント設定",
              "type": "file_exists",
              "path": "agents/*.md",
              "severity": "moderate"
            },
            {
              "id": "ci-cd-pipeline",
              "name": "CI/CD パイプライン",
              "type": "workflow_status",
              "workflows": ["ci.yml", "deploy.yml"],
              "expectedState": "active",
              "severity": "moderate"
            }
          ]
        }
      ]
    },

    "MEDIUM": {
      "description": "データ保護・運用・可用性",
      "failureAction": "daily_report",
      "manusInvestigation": false,
      "repositories": [
        {
          "name": "claude-config",
          "owner": "cursorvers",
          "checks": [
            {
              "id": "config-integrity",
              "name": "設定ファイル整合性",
              "type": "file_exists",
              "path": "CLAUDE.md",
              "severity": "minor"
            }
          ]
        },
        {
          "name": "claude-code-harness",
          "owner": "cursorvers",
          "checks": [
            {
              "id": "harness-health",
              "name": "ハーネス健全性",
              "type": "workflow_status",
              "workflows": ["ci.yml"],
              "expectedState": "active",
              "severity": "minor"
            }
          ]
        }
      ]
    }
  },

  "healthChecks": {
    "apis": [
      {
        "id": "manus-api",
        "name": "Manus API 接続性",
        "url": "https://api.manus.im/health",
        "method": "GET",
        "expectedStatus": 200,
        "timeout": 10000,
        "severity": "severe"
      },
      {
        "id": "supabase-api",
        "name": "Supabase API 接続性",
        "urlEnvVar": "SUPABASE_URL",
        "path": "/rest/v1/",
        "method": "GET",
        "expectedStatus": [200, 401],
        "timeout": 10000,
        "severity": "severe"
      }
    ],
    "secrets": [
      {
        "id": "gh-pat",
        "name": "GitHub PAT",
        "secretName": "GH_PAT",
        "maxAgeDays": 90,
        "severity": "severe"
      },
      {
        "id": "manus-api-key",
        "name": "Manus API Key",
        "secretName": "MANUS_API_KEY",
        "maxAgeDays": 180,
        "severity": "severe"
      },
      {
        "id": "line-channel-secret",
        "name": "LINE Channel Secret",
        "secretName": "LINE_CHANNEL_SECRET",
        "maxAgeDays": 365,
        "severity": "severe"
      }
    ]
  },

  "fallback": {
    "onAuditFailure": {
      "action": "create_github_issue",
      "template": "audit-failure-template.md"
    },
    "onNotificationFailure": {
      "action": "retry_with_email",
      "retryCount": 3
    },
    "onManusUnavailable": {
      "action": "queue_for_manual_review",
      "queueLocation": "github_issues"
    }
  }
}
